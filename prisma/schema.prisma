generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ========== ENUMS ==========
enum TipoPessoa {
  FISICA
  JURIDICA
}

enum TipoContato {
  EMAIL
  TELEFONE_FIXO
  CELULAR
}

enum Situacao {
  ATIVO
  INATIVO
}

enum DiaSemana {
  DOMINGO
  SEGUNDA
  TERCA
  QUARTA
  QUINTA
  SEXTA
  SABADO
}

// ========== TYPES ==========
type Endereco {
  logradouro String
  cep        String
  cidade     String
  uf         String
}

type Contato {
  tipo  TipoContato
  valor String
}

type Responsavel {
  nome     String
  contatos Contato[]
}

type Horario {
  local          String
  diasSemana     DiaSemana[]
  horarioEntrada String
  horarioSaida   String
}

type ControleAcesso {
  senha             String
  impressaoDigital1 String? // Armazenada como hash/base64
  impressaoDigital2 String? // Armazenada como hash/base64
}

// ========== MODELS ==========
model Pessoa {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  codigo    String   @unique
  tipo      String   // FISICA ou JURIDICA
  nome1     String
  nome2     String?
  doc1      String   @unique  // CPF ou CNPJ
  doc2      String?
  dtNsc     DateTime?
  situacao  String   @default("ATIVO")
  
  // ✅ Campos JSON (não são modelos relacionados)
  enderecos Json[]   @default([])
  contatos  Json[]   @default([])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  alunos       Aluno[]
  funcionarios Funcionario[]

  @@map("pessoas")
}

model User {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  nome      String
  email     String    @unique
  dtNasc    DateTime?
  password  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("users")
}

model Aluno {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Referência à Pessoa (relacionamento)
  pessoaId String @db.ObjectId
  matricula         String    @unique
  pessoa   Pessoa @relation(fields: [pessoaId], references: [id], onDelete: Cascade)

  // Dados específicos do Aluno
  vldExameMedico DateTime? @db.Date
  vldAvaliacao   DateTime? @db.Date
  objetivo       String?
  profissao      String?
  empresa        String?

  // Responsável
  responsavel Responsavel?

  // Lista de Horários
  horarios Horario[]

  // Controle de Acesso
  controleAcesso ControleAcesso

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pessoaId])
}

model Local {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  nome      String
  status    String   @default("ATIVO") // ATIVO, INATIVO
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("locais")
}
enum Periodicidade {
  MENSAL
  BIMESTRAL
  TRIMESTRAL
  QUADRIMESTRAL
  SEMESTRAL
  ANUAL
  MESES          // Personalizado: X meses
  DIAS           // Personalizado: X dias
}

model Plano {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  codigo            String         @unique
  nome              String
  periodicidade     Periodicidade
  numeroMeses       Int?           // Usado quando periodicidade = MESES
  numeroDias        Int?           // Usado quando periodicidade = DIAS
  valorMensalidade  Float
  status            String         @default("ATIVO") // ATIVO, INATIVO
  descricao         String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@map("planos")
}

model Funcao {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  funcao    String   @unique
  status    String   @default("ATIVO")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

    funcionarios Funcionario[]

  @@map("funcoes")
}

model Desconto {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  descricao String
  tipo      String   // PERCENTUAL ou MONETARIO
  valor     Float
  status    String   @default("ATIVO")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("descontos")
}

model Funcionario {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  pessoaId  String   @unique @db.ObjectId
  pessoa    Pessoa   @relation(fields: [pessoaId], references: [id])
  
  matricula String   @unique
  funcaoId  String   @db.ObjectId  // ✅ NOVO: ID da função
  funcao    Funcao   @relation(fields: [funcaoId], references: [id])  // ✅ NOVO: Relacionamento
  dataAdmissao DateTime
  dataDemissao DateTime?
  salario   Float?
  situacao  String   @default("ATIVO")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([funcaoId])  // ✅ NOVO: Índice para performance
  @@map("funcionarios")
}

model Turma {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  nome         String   @unique
  sexo         String   // MASCULINO, FEMININO, AMBOS
  observacoes  String?
  
  // Lista de horários com local
  horarios     Json[]   // Array de { localId, local, diasSemana, horaEntrada, horaSaida }
  
  // Lista de instrutores
  instrutores  Json[]   // Array de { funcionarioId, nome }
  
  status       String   @default("ATIVO")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("turmas")
}

